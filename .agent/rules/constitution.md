---
trigger: always_on
---

# 时空同步战术 (Chrono-Kinetic Tactics) 项目宪章

## 核心原则

### 一、速度作为第一性属性

**速度是唯一统御所有时间行为的属性。** 移动距离、施法时长、动画播放速率全部由单位的 `speed` 属性通过确定性公式推导（例如 `T_实际 = T_基础 / (1 + α × 速度/100)`）。

**理据**: 传统 RPG/战棋游戏将"移动速度"、"攻击速度"、"施法速度"切割为互不关联的属性，导致单位设计混乱。统一速度创造涌现式策略深度：高速单位成为"时间操控者"，在相同回合窗口内执行更多行动，直接实现设计愿景"速度即是行动权"。

**不可协商规则**:
- 禁止分离的移动/攻击/施法速度属性
- 时长计算必须使用反比例缩放公式以防止速度趋零漏洞
- UI 必须展示速度的多维影响（如"200 速度 = 2倍移动 + 2倍施法"）

### 二、确定性物理替代随机数生成器

**战斗结果由时空几何决定，而非随机数生成器。**"命中"或"未中"通过特定时间帧的 Hitbox/Hurtbox 碰撞判定，而非骰子。

**理据**: 随机命中率制造"95%未命中"的挫败时刻，破坏玩家信任。基于物理的战斗使结果可预测但复杂：高速单位可以在伤害判定前物理移出 AoE 范围。这将技巧表达从"概率管理"转移到"几何预判"，契合文档中"物理主导"的愿景。

**不可协商规则**:
- 核心战斗判定（命中/闪避/暴击）零随机数
- 碰撞检测必须使用精确形状相交（非近似）
- 边缘情况（如"擦弹"）使用几何学（重叠百分比）而非随机概率

### 三、WEGO（同时回合制）时间模型

**所有单位在共享时间轴上并发执行动作。** 玩家和 AI 在规划阶段提交动作序列；执行阶段以实时速度同步播放。

**理据**: 传统 IGOUGO（"我方-敌方"）回合强制人为的时间冻结，敌人在玩家移动期间静止不动。WEGO 消除这种抽象，实现真正的"惯性闪避"，单位的动量至关重要。这是文档"时空同步"哲学的基础。

**不可协商规则**:
- 禁止"敌方回合暂停"——所有动作共享一个时钟
- 动作必须编码为带有 `start_time` + `duration` 的 `CombatAction` 资源
- 规划阶段禁止修改世界状态（仅预览）

### 四、时间轴可预测性与可视化

**玩家必须能够拖动时间查看未来精确的单位位置/状态。** 时间轴 UI 不是装饰——它是预先计算碰撞结果的功能性模拟引擎。

**理据**: WEGO 的复杂性需要透明的预测工具以避免认知过载。文档明确要求"幽灵轨迹"和"碰撞警告点"，将抽象时间转化为具象视觉。没有这些，玩家将盲目猜测。

**不可协商规则**:
- `CombatAction.evaluate_state(time)` 必须为任意 `t` 返回确定性状态
- 时间轴滑块必须在预览时间渲染"幽灵单位"
- 碰撞警告（如"将在 t=2.3秒 被击中"）必须视觉标记

### 五、命令模式实现时间旅行

**所有游戏状态变更编码为可重放、可逆的命令对象。** 这使得撤销/重做、动作序列保存/加载、AI 模拟成为可能。

**理据**: 为实现"确定性物理模拟"，规划期间不能依赖可变世界状态。命令模式分离"意图记录"与"执行"，使预览系统的快进计算在无副作用情况下可行。

**不可协商规则**:
- 规划阶段禁止直接属性修改（如 `unit.position = x`）
- 所有动作必须继承自 `CombatAction` 或等效可序列化资源
- 执行阶段必须按严格的 `start_time` 顺序应用命令

## 设计约束

### 物理确定性
- 所有移动/弹道计算在相同输入下必须产生完全相同的结果
- Godot 的 `PhysicsServer` 仅用于可视化；逻辑模拟在纯数学"影子世界"中运行
- 要求帧率独立：模拟循环使用固定时间步长（如 0.05 秒）

### UI/UX 要求
- 时间轴 UI 必须支持:
  - 拖动滑块浏览 0 到 `turn_duration`
  - 多轨道显示（玩家动作、敌方动作、环境事件）
  - "吸附到关键帧"辅助（如碰撞时刻）
- 信息层级: 紧迫威胁（高对比度） > 潜在威胁（半透明） > 数据（悬停提示）

### 性能标准
- 时间轴预览在 ≤10 个单位时必须达到 60 FPS
- 动作模拟必须在 100ms 内完成 5 秒回合窗口计算
- 幽灵轨迹渲染通过批量 `Line2D` 或基于着色器的粒子优化

## 开发工作流

### 功能优先级
1. **核心循环优先**: 时间轴 → 动作 → 预览 → 执行循环必须在添加新卡牌类型前运作
2. **物理先于内容**: 碰撞系统必须稳定后再设计复杂攻击模式
3. **AI 作为验证**: 尽早实现基础敌方 AI 以测试预测系统在对抗行为下是否真正有效

### 测试纪律
- **单元测试**: 每个 `CombatAction.evaluate_state()` 实现必须有时间参数化测试
- **集成测试**: "未来位置匹配"测试验证预览状态 == 执行状态（在任意 `t`）
- **确定性测试**: 记录动作序列 → 重放 100 次 → 断言相同结果

### 代码审查门禁
- 无以下条件不得合并 PR:
  - 命令模式合规（规划代码无直接状态修改）
  - 速度公式遵守（所有时间计算使用批准公式）
  - 时间轴 UI 同步（新动作类型必须在时间轴渲染）

## 治理

**本宪章凌驾于临时设计决策。** 当功能需求与原则冲突时（如"添加暴击随机数"），原则获胜，除非提出正式修订案。

**修订流程**:
1. 在 `.specify/memory/amendment-proposal.md` 记录提议变更
2. 详述对现有功能、模板和代码库的影响
3. 需项目负责人明确批准
4. 更新宪章版本（移除原则为 MAJOR，新增为 MINOR，澄清为 PATCH）
5. 将变更传播到所有依赖模板和指导文件

**版本策略**:
- 版本格式: `MAJOR.MINOR.PATCH`
- 所有修改宪章的 git 提交必须在提交信息中包含版本更新
- 对核心系统的破坏性变更（如移除 WEGO）触发 MAJOR 更新

**合规审查**:
- 每次迭代回顾包含"宪章遵守检查"
- 违规记录在 `.specify/memory/violations-log.md` 并附补救计划
- 重复违反不可协商规则触发架构审查

**版本**: 1.0.0 | **批准日期**: 2025-12-05 | **最后修订**: 2025-12-05
